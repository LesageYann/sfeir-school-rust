<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="utf-8"/>

  <title>SFEIR School - Battleship</title>
</head>

<body>
<style>
  .main {
    max-width: 950px;
    display: grid;
    grid-template-columns: 545px 1fr;
    gap: 10px;
  }

  .main > * {
    border: black 1px solid;
  }

  aside {
    padding: 10px;
  }

  #board {
    background-color: grey;
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    grid-template-rows: repeat(10, 1fr);
    gap: 1px;
    width: 545px;
    height: 545px;
  }

  .case {
    background-color: #cccccc;
  }
</style>
<div>
  <h1>Battleship</h1>

  <div id="actions">
    <button id="reset">Reset</button>
  </div>
  <h2> your board</h2>
  <div class="main">
    <div id="board">
      <div id="A0" class="case"></div>
      <div id="A1" class="case"></div>
      <div id="A2" class="case"></div>
      <div id="A3" class="case"></div>
      <div id="A4" class="case"></div>
      <div id="A5" class="case"></div>
      <div id="A6" class="case"></div>
      <div id="A7" class="case"></div>
      <div id="A8" class="case"></div>
      <div id="A9" class="case"></div>
      <div id="B0" class="case"></div>
      <div id="B1" class="case"></div>
      <div id="B2" class="case"></div>
      <div id="B3" class="case"></div>
      <div id="B4" class="case"></div>
      <div id="B5" class="case"></div>
      <div id="B6" class="case"></div>
      <div id="B7" class="case"></div>
      <div id="B8" class="case"></div>
      <div id="B9" class="case"></div>
      <div id="C0" class="case"></div>
      <div id="C1" class="case"></div>
      <div id="C2" class="case"></div>
      <div id="C3" class="case"></div>
      <div id="C4" class="case"></div>
      <div id="C5" class="case"></div>
      <div id="C6" class="case"></div>
      <div id="C7" class="case"></div>
      <div id="C8" class="case"></div>
      <div id="C9" class="case"></div>
      <div id="D0" class="case"></div>
      <div id="D1" class="case"></div>
      <div id="D2" class="case"></div>
      <div id="D3" class="case"></div>
      <div id="D4" class="case"></div>
      <div id="D5" class="case"></div>
      <div id="D6" class="case"></div>
      <div id="D7" class="case"></div>
      <div id="D8" class="case"></div>
      <div id="D9" class="case"></div>
      <div id="E0" class="case"></div>
      <div id="E1" class="case"></div>
      <div id="E2" class="case"></div>
      <div id="E3" class="case"></div>
      <div id="E4" class="case"></div>
      <div id="E5" class="case"></div>
      <div id="E6" class="case"></div>
      <div id="E7" class="case"></div>
      <div id="E8" class="case"></div>
      <div id="E9" class="case"></div>
      <div id="F0" class="case"></div>
      <div id="F1" class="case"></div>
      <div id="F2" class="case"></div>
      <div id="F3" class="case"></div>
      <div id="F4" class="case"></div>
      <div id="F5" class="case"></div>
      <div id="F6" class="case"></div>
      <div id="F7" class="case"></div>
      <div id="F8" class="case"></div>
      <div id="F9" class="case"></div>
      <div id="G0" class="case"></div>
      <div id="G1" class="case"></div>
      <div id="G2" class="case"></div>
      <div id="G3" class="case"></div>
      <div id="G4" class="case"></div>
      <div id="G5" class="case"></div>
      <div id="G6" class="case"></div>
      <div id="G7" class="case"></div>
      <div id="G8" class="case"></div>
      <div id="G9" class="case"></div>
      <div id="H0" class="case"></div>
      <div id="H1" class="case"></div>
      <div id="H2" class="case"></div>
      <div id="H3" class="case"></div>
      <div id="H4" class="case"></div>
      <div id="H5" class="case"></div>
      <div id="H6" class="case"></div>
      <div id="H7" class="case"></div>
      <div id="H8" class="case"></div>
      <div id="H9" class="case"></div>
      <div id="I0" class="case"></div>
      <div id="I1" class="case"></div>
      <div id="I2" class="case"></div>
      <div id="I3" class="case"></div>
      <div id="I4" class="case"></div>
      <div id="I5" class="case"></div>
      <div id="I6" class="case"></div>
      <div id="I7" class="case"></div>
      <div id="I8" class="case"></div>
      <div id="I9" class="case"></div>
      <div id="J0" class="case"></div>
      <div id="J1" class="case"></div>
      <div id="J2" class="case"></div>
      <div id="J3" class="case"></div>
      <div id="J4" class="case"></div>
      <div id="J5" class="case"></div>
      <div id="J6" class="case"></div>
      <div id="J7" class="case"></div>
      <div id="J8" class="case"></div>
      <div id="J9" class="case"></div>
    </div>
    <aside>
      <label for="playerId">Player</label>
      <input id="playerId" />
      <div class="stats">

      </div>
    </aside>
  </div>
  <div id="answer"></div>
  <script>
    const board = document.getElementById('board');
    const cases = board.getElementsByClassName('case');

    let player = "enter your name";
    let stats;

    function turn(event) {
        fetch(`http://localhost:3000/play`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'fake-auth': 'sfeir-2024',
          },
          body: JSON.stringify({
            case: event.target.id,
            player
          })
        })
          .then(response => response.json())
          .then(data => {
            displayStats();
            if (data.finished) {
            }
            if (data.hit) {
              event.target.style.backgroundColor = 'red';
            } else {
              event.target.style.backgroundColor = 'blue';
            }
            document.getElementById("answer").innerText = data.message || "";
          })
          .catch(error => {
            console.error('Error:', error);
          });
    }

    function playerChange(event) {
      player = event.target.value;
      reset();
    }

    const reset = debounce(() => {
      fetch("http://localhost:3000/play", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'fake-auth': 'sfeir-2024',
        },
        body: JSON.stringify({
          case: event.target.id,
          player
        })
      })
        .then(cases => {
          cases.forEach((c, i) => {
            c.style.backgroundColor = '#cccccc';
          });
        })
      displayStats();
    })

    function debounce(func, timeout = 300) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => {
          func.apply(this, args);
        }, timeout);
      };
    }

    function displayStats() {
      fetch("http://localhost:3000/player/stats", {
        headers: {
          'fake-auth': 'sfeir-2024',
        }
      })
        .then(stats => {
          let element = document.querySelector('#stats');
          element.innerHTML="";
          stats.forEach(stat =>{
             const div = document.createElement('div');
             div.innerText = `${stat[0]} : ${stat[1]} `;
             element.appendChild(div);
          })
        })
    }

    // ================================================
    // events
    // ================================================
    board.addEventListener('click', debounce(turn));
    document.getElementById('playerId').addEventListener("onchange", playerChange);

  </script>

</body>

</html>
